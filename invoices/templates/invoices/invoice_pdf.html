{% load invoice_tags %}
<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if invoice.language == 'de' %}Rechnung{% else %}Invoice{% endif %} {{ invoice.invoice_number }}</title>
    <style>
        @page {
            size: A4;
            margin: 0.1cm 1.5cm 1.0cm 1.5cm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1.5;
            color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .company-logo {
            max-width: 16cm;
            max-height: 6cm;
            margin-left: -15mm;
            margin-top: -10mm;
        }

        .company-info {
            text-align: right;
        }

        .company-name {
            font-size: 16pt;
            font-weight: 600;
            color: #000;
            margin-bottom: 2px;
            letter-spacing: 2px;
        }

        .company-subtitle {
            font-size: 8pt;
            color: #999;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .invoice-title-section {
            text-align: right;
            margin-top: 5px;
        }

        .invoice-title {
            font-size: 32pt;
            font-weight: 300;
            color: #000;
            letter-spacing: 3px;
            margin-bottom: 5px;
        }

        .invoice-number {
            font-size: 14pt;
            color: #666;
            font-weight: 300;
        }

        .invoice-meta {
            margin-bottom: 15px;
            margin-top: 5px;
        }

        .meta-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 10pt;
        }

        .meta-label {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 9pt;
            letter-spacing: 0.5px;
            width: 180px;
            color: #000;
        }

        .meta-value {
            color: #666;
            font-size: 11pt;
        }

        .meta-value.prominent {
            font-size: 14pt;
            font-weight: 600;
            color: #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        thead {
            border: 2px solid #000;
            background-color: #f9f9f9;
        }

        th {
            padding: 5px;
            text-align: left;
            font-weight: 600;
            font-size: 9pt;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #000;
            border: 1px solid #000;
        }

        th.right,
        td.right {
            text-align: right;
        }

        td {
            padding: 5px;
            font-size: 10pt;
            color: #333;
            border: 1px solid #000;
        }

        .totals-section {
            margin-top: 30px;
            margin-left: auto;
            width: 350px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 10pt;
        }

        .totals-row.subtotal {
            color: #999;
            border-bottom: 1px solid #eee;
        }

        .totals-row.vat {
            color: #999;
            font-size: 9pt;
        }

        .totals-row.total {
            font-size: 16pt;
            font-weight: 600;
            color: #000;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #000;
        }

        .payment-section {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .payment-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
            font-size: 10pt;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-row {
            display: flex;
            margin-bottom: 6px;
            font-size: 9pt;
        }

        .payment-label {
            width: 140px;
            color: #666;
        }

        .payment-value {
            color: #333;
            font-weight: 500;
            font-size: 11pt;
        }

        .footer {
            margin-top: 80px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 8pt;
            color: #999;
        }

        .notes {
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            font-size: 9pt;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="header">
        {% if company.logo and company.display_logo %}
        <img src="file://{{ company.logo.path }}" alt="{{ company.company_name }}" class="company-logo">
        {% endif %}

        <div class="company-info">
            {% if company.display_company_name %}
            <div class="company-name">{{ company.company_name|upper }}</div>
            {% endif %}
            {% if company.uid %}
            <div class="company-subtitle">UID: {{ company.uid }}</div>
            {% endif %}

            <div style="font-size: 11pt; color: #666; margin-bottom: 2px;">
                {{ company.address|linebreaksbr }}<br>
                {{ company.email }}<br>
                {{ company.phone }}
            </div>

            <div class="invoice-title-section">
                <div class="invoice-title">{% if invoice.language == 'de' %}RECHNUNG{% else %}INVOICE{% endif %}</div>
                <div class="invoice-number">{{ invoice.invoice_number }}</div>
            </div>
        </div>
    </div>

    <div class="invoice-meta">
        <div class="meta-row">
            <div class="meta-label">{% if invoice.language == 'de' %}Rechnungsempfänger:{% else %}Billed To:{% endif %}
            </div>
            <div class="meta-value">
                <strong>{{ client.name }}</strong><br>
                {% if client.name_extension %}{{ client.name_extension }}<br>{% endif %}
                {{ client.address|linebreaksbr }}<br>
                {% if client.email %}{{ client.email }}<br>{% endif %}
                {% if client.phone %}{{ client.phone }}<br>{% endif %}
                {% if client.uid %}UID: {{ client.uid }}{% endif %}
            </div>
        </div>
        <div class="meta-row">
            <div class="meta-label">{% if invoice.language == 'de' %}Datum:{% else %}Date:{% endif %}</div>
            <div class="meta-value promiment">
                {% if invoice.language == 'de' %}{{ invoice.date|date:"d.m.Y" }}{% else %}{{ invoice.date|date:"d F, Y" }}{% endif %}
            </div>
        </div>
    </div>

    {# SERVICE TABLE #}
    {% if service_items %}
    <table>
        <thead>
            <tr>
                <th style="width: 25%;">{% if invoice.language == 'de' %}LEISTUNG{% else %}SERVICE{% endif %}</th>
                <th style="width: 35%;">DETAILS</th>
                <th class="right" style="width: 10%;">{% if invoice.language == 'de' %}MENGE{% else %}QTY{% endif %}
                </th>
                <th class="right" style="width: 15%;">{% if invoice.language == 'de' %}EINZELPREIS{% else %}UNIT PRICE{% endif %}</th>
                <th class="right" style="width: 15%;">SUMME</th>
            </tr>
        </thead>
        <tbody>
            {% for item in service_items %}
            <tr>
                <td>{{ item.product.name|default:item.description }}</td>
                <td>{{ item.description }}</td>
                <td class="right">{{ item.quantity|floatformat:"-2" }}</td>
                <td class="right">{{ item.get_unit_rate_display|currency_de }} €</td>
                <td class="right">{{ item.total|currency_de }} €</td>
            </tr>
            {% endfor %}
            {# Service Subtotal #}
            <tr>
                <td colspan="2" style="font-weight: 600; background: #f9f9f9;">{% if invoice.language == 'de' %}SUMME
                    LEISTUNG{% else %}SERVICE TOTAL{% endif %}</td>
                <td colspan="2" style="border: none;"></td>
                <td class="right" style="font-weight: 600; background: #f9f9f9;">{{ service_net|currency_de }} €</td>
            </tr>
            <tr>
                <td colspan="2" style="color: #666;">{{ invoice.vat_rate }}% {{ vat_label }}</td>
                <td colspan="2" style="border: none;"></td>
                <td class="right" style="color: #666;">{{ service_vat|currency_de }} €</td>
            </tr>
            <tr>
                <td colspan="2" style="font-weight: 600;">{% if invoice.language == 'de' %}GESAMT LEISTUNG{% else %}SERVICE GROSS TOTAL{% endif %}</td>
                <td colspan="2" style="border: none;"></td>
                <td class="right" style="font-weight: 600;">{{ service_gross|currency_de }} €</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {# EXPENSE TABLE #}
    {% if expense_items %}
    <table style="margin-top: 20px;">
        <thead>
            <tr>
                <th style="width: 25%;">{% if invoice.language == 'de' %}SPESEN{% else %}EXPENSES{% endif %}</th>
                <th style="width: 35%;">{% if invoice.language == 'de' %}BESCHREIBUNG{% else %}DESCRIPTION{% endif %}
                </th>
                <th class="right" style="width: 10%;">{% if invoice.language == 'de' %}MENGE{% else %}QTY{% endif %}
                </th>
                <th class="right" style="width: 15%;">{% if invoice.language == 'de' %}EINZELPREIS{% else %}UNIT PRICE{% endif %}</th>
                <th class="right" style="width: 15%;">SUMME</th>
            </tr>
        </thead>
        <tbody>
            {% for item in expense_items %}
            <tr>
                <td>{{ item.product.name|default:"Spesen" }}</td>
                <td>{{ item.description }}</td>
                <td class="right">{{ item.quantity|floatformat:"-2" }}</td>
                <td class="right">{{ item.unit_price|currency_de }} €</td>
                <td class="right">{{ item.total|currency_de }} €</td>
            </tr>
            {% endfor %}
            {# Expense Subtotal #}
            <tr>
                <td colspan="2" style="font-weight: 600; background: #f9f9f9;">{% if invoice.language == 'de' %}SUMME
                    SPESEN{% else %}EXPENSE TOTAL{% endif %}</td>
                <td colspan="2" style="border: none;"></td>
                <td class="right" style="font-weight: 600; background: #f9f9f9;">{{ expense_total|currency_de }} €</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {# MILEAGE TABLE #}
    {% if mileage_items %}
    <table style="margin-top: 20px;">
        <thead>
            <tr>
                <th style="width: 25%;">{% if invoice.language == 'de' %}KILOMETERGELD{% else %}MILEAGE{% endif %}</th>
                <th style="width: 35%;">DETAILS</th>
                <th class="right" style="width: 10%;">KM</th>
                <th class="right" style="width: 15%;">RATE</th>
                <th class="right" style="width: 15%;">SUMME</th>
            </tr>
        </thead>
        <tbody>
            {% for item in mileage_items %}
            <tr>
                <td>{{ item.description }}</td>
                <td>
                    <small style="color: #666;">
                        {% if invoice.language == 'de' %}({{ item.num_people }} Person{{ item.num_people|pluralize:"en" }}){% else %}({{ item.num_people }} Person{{ item.num_people|pluralize }}){% endif %}
                    </small>
                </td>
                <td class="right">{{ item.quantity|floatformat:"-2" }}</td>
                <td class="right">{{ item.get_unit_rate_display|currency_de }} €</td>
                <td class="right">{{ item.total|currency_de }} €</td>
            </tr>
            {% endfor %}
            {# Mileage Subtotal #}
            <tr>
                <td colspan="2" style="font-weight: 600; background: #f9f9f9;">{% if invoice.language == 'de' %}SUMME
                    KILOMETERGELD{% else %}MILEAGE TOTAL{% endif %}</td>
                <td colspan="2" style="border: none;"></td>
                <td class="right" style="font-weight: 600; background: #f9f9f9;">{{ mileage_total|currency_de }} €</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {# FINAL MAIN TOTAL #}
    <div style="margin-top: 30px; text-align: right;">
        <table style="width: 350px; margin-left: auto; border: none; margin-top: 0;">
            <tr style="border: 2px solid #000;">
                <td class="right" style="font-size: 14pt; font-weight: 600; padding: 10px; width: 50%;">GESAMT</td>
                <td class="right" style="font-size: 14pt; font-weight: 600; padding: 10px; width: 50%;">{{ gross_total|currency_de }} €</td>
            </tr>
        </table>
    </div>


    {% if invoice.notes %}
    <div style="margin-top: 10px; text-align: left; font-weight: bold;">
        {{ invoice.notes|linebreaksbr }}
    </div>
    {% endif %}

    <div class="payment-section">
        <div class="payment-row">
            <div class="payment-label">{% if invoice.language == 'de' %}ZAHLBAR BIS:{% else %}DUE DATE:{% endif %}</div>
            <div class="payment-value prominent" style="color: #d97706;">
                {% if invoice.language == 'de' %}{{ invoice.due_date|date:"d.m.Y" }}{% else %}{{ invoice.due_date|date:"d F, Y" }}{% endif %}
            </div>
        </div>
        {% if company.iban %}
        <div class="payment-row">
            <div class="payment-label">IBAN:</div>
            <div class="payment-value prominent" style="color: #000; font-weight: 700;">{{ company.iban }}</div>
        </div>
        {% endif %}

        <div style="margin-top: 30px;">
            <div class="payment-title">{% if invoice.language == 'de' %}Zahlungsinfo:{% else %}Pay To:{% endif %}</div>
            <div class="payment-row">
                <div class="payment-label">
                    {% if invoice.language == 'de' %}Kontoinhaber{% else %}Account Name{% endif %}
                </div>
                <div class="payment-value">{{ company.company_name }}</div>
            </div>
            {% if payment_info %}
            <div style="margin-top: 15px; font-size: 9pt; color: #999;">
                {{ payment_info|linebreaksbr }}
            </div>
            {% endif %}
        </div>
    </div>



    <div class="footer">
        {% if company.display_address %}{{ company.address|linebreaksbr }}{% endif %}
        {% if company.display_address and company.display_phone %} - {% endif %}
        {% if company.display_phone %}{{ company.phone }}{% endif %}
        {% if company.display_address and company.display_email or company.display_phone and company.display_email %} -
        {% endif %}
        {% if company.display_email %}{{ company.email }}{% endif %}
    </div>
</body>

</html>